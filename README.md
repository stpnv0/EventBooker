# EventBooker

Сервис бронирования мест на мероприятия с автоматической отменой неоплаченных броней.

Позволяет создавать мероприятия, бронировать места, подтверждать оплату и автоматически освобождать места при истечении срока подтверждения.

---

## Возможности

### Основные
- **Создание мероприятий** — название, описание, дата, количество мест, настраиваемый TTL бронирования
- **Бронирование мест** — с проверкой доступности в транзакции 
- **Подтверждение оплаты** — с проверкой TTL и статуса
- **Автоматическая отмена** — фоновый планировщик отменяет просроченные брони
- **Свободная запись** — мероприятия без обязательного подтверждения (бронь сразу `confirmed`)
- **Подсчёт свободных мест** — вычисляется динамически через SQL JOIN (нет рассинхронизации)

### Дополнительные
- **Telegram-уведомления** — о создании, подтверждении и отмене бронирования
- **Настраиваемый TTL** — разный срок жизни брони для каждого мероприятия
- **Веб-интерфейс** — панель пользователя и администратора

---

## 🔧 Стек технологий

| Категория       | Технология                    |
|-----------------|-------------------------------|
| Язык            | Go 1.25                       |
| HTTP-фреймворк  | Gin (через wbf/ginext)        |
| База данных     | PostgreSQL 17                 |
| Миграции        | goose v3                      |
| Конфигурация    | cleanenv + validator          |
| Логирование     | wbf/logger (slog/zap/zerolog) |
| Telegram        | go-telegram-bot-api/v5        |
| UUID            | google/uuid                   |
| Контейнеризация | Docker, Docker Compose        |
| Фронтенд        | JS, HTML, CSS                 |

---

## 📡 API

### Events

| Метод | Путь | Описание |
|-------|------|----------|
| `POST` | `/api/events` | Создать мероприятие |
| `GET` | `/api/events` | Список мероприятий |
| `GET` | `/api/events/:id` | Детали мероприятия (свободные места, бронирования) |

### Bookings

| Метод | Путь | Описание |
|-------|------|----------|
| `POST` | `/api/events/:id/book` | Забронировать место |
| `POST` | `/api/events/:id/confirm` | Подтвердить оплату |

### Users

| Метод | Путь | Описание |
|-------|------|----------|
| `POST` | `/api/users` | Регистрация пользователя |
| `GET` | `/api/users` | Список пользователей |
| `GET` | `/api/users/:id/bookings` | Бронирования пользователя |

---

## Запуск

### Docker Compose

```bash
# Клонировать
git clone https://github.com/stpnv0/EventBooker.git
cd EventBooker

# Настроить (опционально)
export TELEGRAM_BOT_TOKEN=your-token

# Запустить
docker-compose up --build

# Открыть
http://localhost:8080
```

### Локально

```bash
# 1. Поднять PostgreSQL
docker-compose up postgres -d

# 2. Настроить конфиг
cp config/config.yaml config/config.local.yaml
# отредактировать config.local.yaml

# 3. Запустить
go run cmd/event_booker/main.go --config config/config.yaml
```


## Структура проекта

```
EventBooker/
├── cmd/
│   └── event_booker/                # Точка входа
├── config/                          # Конфигурация
├── internal/
│   ├── app/                         # Сборка и жизненный цикл приложения
│   ├── config/                      # Структуры конфигурации
│   ├── domain/                      # основные сущности и бизнес ошибки
│   ├── repository/                  # Postgres репозиторий
│   ├── service/                     # Бизнес-логика 
│   ├── handler/                     # DTO + HTTP обработчики
│   ├── router/                      # Маршруты
│   ├── middleware/                  # Логирование запросов,Обработка паник, X-Request-ID
│   ├── notification/                # Telegram-уведомления
│   └── scheduler/                   # Фоновая отмена просроченных броней
├── migrations/                      # Goose миграции
├── web/                             # Веб-интерфейс
├── Dockerfile
├── docker-compose.yml
├── go.mod
├── go.sum
└── README.md
```
---


## Telegram-уведомления

| Событие                                  | Сообщение                                          |
|------------------------------------------|----------------------------------------------------|
| Бронирование создано (pending)           | Место забронировано! Подтвердите в течение N минут |
| Бронирование подтверждено (confirmed)    | Бронирование подтверждено!                         |
| Бронирование отменено (TTL) (cancelled)  | Бронирование отменено (истекло время оплаты)       |

Для включения:
1. Создать бота через `@BotFather`
2. Указать токен в `TELEGRAM_BOT_TOKEN`
3. При регистрации пользователя указать `telegram_chat_id`

Уведомления отправляются **асинхронно** в горутинах

---


## Схема базы данных

```
┌───────────────────┐     ┌──────────────────┐     ┌──────────────┐
│    events         │     │     bookings     │     │    users     │
├───────────────────┤     ├──────────────────┤     ├──────────────┤
│ id (PK)           │◄────│ event_id (FK)    │     │ id (PK)      │
│ title             │     │ user_id (FK)     │────►│ username     │
│ description       │     │ id (PK)          │     │ telegram_id  │
│ event_date        │     │ status           │     │ created_at   │
│ total_spots       │     │ created_at       │     └──────────────┘
│ booking_ttl       │     │ updated_at       │
│ requires_ payment │     └──────────────────┘
│ created_at        │
│ updated_at        │
└───────────────────┘
```